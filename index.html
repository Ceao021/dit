<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>全景图浏览器</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css">
    <style>
        :root {
            color-scheme: light dark;
            --accent: #0078d4;
            --bg: #f5f5f5;
            --panel: rgba(255, 255, 255, 0.9);
            --text: #222;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: "Segoe UI", "PingFang SC", sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
        }

        .app {
            display: flex;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
        }

        aside {
            width: 320px;
            background: var(--panel);
            backdrop-filter: blur(8px);
            border-right: 1px solid rgba(0, 0, 0, 0.08);
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        main {
            flex: 1;
            position: relative;
        }

        #panorama {
            width: 100%;
            height: 100%;
        }

        h1 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
        }

        .nav-buttons,
        .dataset-toggle {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .nav-buttons {
            grid-template-columns: repeat(2, 1fr);
        }

        button {
            border: 1px solid rgba(0, 0, 0, 0.15);
            background: rgb(85, 85, 85);
            padding: 8px 12px;
            font-size: 14px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        button:hover:not(:disabled) {
            border-color: var(--accent);
            color: var(--accent);
        }

        button:disabled {
            opacity: 0.35;
            cursor: not-allowed;
        }

        .dataset-btn.active {
            background: var(--accent);
            color: #ffffff;
            border-color: var(--accent);
        }

        .meta {
            font-size: 13px;
            line-height: 1.6;
            background: rgba(0, 0, 0, 0.03);
            padding: 8px;
            border-radius: 6px;
        }

        .thumbs {
            flex: 1;
            overflow-y: auto;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 8px;
            padding-right: 4px;
        }

        .thumbnail {
            display: flex;
            flex-direction: column;
            gap: 4px;
            border: 1px solid transparent;
            padding: 6px;
            background: rgba(255, 255, 255, 0.7);
        }

        .thumbnail img {
            width: 100%;
            height: 70px;
            object-fit: cover;
            border-radius: 4px;
            background: #ddd;
        }

        .thumbnail span {
            font-size: 11px;
            text-align: center;
            color: #444;
        }

        .thumbnail.active {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(0, 120, 212, 0.2);
        }

        .status {
            min-height: 18px;
            font-size: 12px;
            color: #c2410c;
        }

        @media (max-width: 900px) {
            .app {
                flex-direction: column;
            }

            aside {
                width: 100%;
                max-height: 360px;
            }

            .thumbs {
                grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="app">
        <aside>
            <h1>全景图浏览器</h1>
            <div class="nav-buttons">
                <button id="prevBtn">上一张</button>
                <button id="nextBtn">下一张</button>
            </div>
            <div class="dataset-toggle">
                <button class="dataset-btn active" data-dataset="panos">输入</button>
                <button class="dataset-btn" data-dataset="fill">结果1</button>
                <button class="dataset-btn" data-dataset="editing">结果2</button>
            </div>
            <div class="meta">
                <div>当前图像：<span id="currentName">-</span></div>
                <div>当前视图：<span id="currentDataset">输入</span></div>
            </div>
            <div class="status" id="statusMessage"></div>
            <div class="thumbs" id="thumbnailGrid"></div>
        </aside>
        <main>
            <div id="panorama"></div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"></script>
    <script>
        const datasetLabels = {
            panos: '输入',
            fill: '结果1',
            editing: '结果2'
        };

        const datasetFiles = {
            "panos": ["0001_01.png","0001_02.png","0002_01.png","0002_02.png","0004_01.png","0005_01.png","0005_02.png","0006_01.png","0006_02.png","0012_01.png","0012_02.png","0012_03.png","0013_01.png","0013_02.png","0015_01.png","0015_02.png","0019_01.png","0024_01.png","0024_02.png","0027_01.png","0032_01.png"],
            "fill": ["0001_01.png","0001_02.png","0002_01.png","0002_02.png","0004_01.png","0005_01.png","0005_02.png","0006_01.png","0006_02.png","0012_01.png","0012_02.png","0012_03.png","0013_01.png","0013_02.png","0015_01.png","0015_02.png","0019_01.png","0024_01.png","0024_02.png","0027_01.png","0032_01.png"],
            "editing": ["0001_01.png","0001_02.png","0002_01.png","0002_02.png","0004_01.png","0005_01.png","0005_02.png","0006_01.png","0006_02.png","0012_01.png","0012_02.png","0012_03.png","0013_01.png","0013_02.png","0015_01.png","0015_02.png","0019_01.png","0024_01.png","0024_02.png","0027_01.png","0032_01.png"],
        };

        const datasetSets = Object.fromEntries(Object.entries(datasetFiles).map(([k, list]) => [k, new Set(list)]));
        const panoramaList = datasetFiles.panos;

        const state = {
            index: 0,
            dataset: 'panos',
            viewer: null
        };

        const refs = {
            currentName: document.getElementById('currentName'),
            currentDataset: document.getElementById('currentDataset'),
            statusMessage: document.getElementById('statusMessage'),
            thumbnailGrid: document.getElementById('thumbnailGrid'),
            datasetButtons: document.querySelectorAll('.dataset-btn')
        };

        const createViewer = (panoramaPath, view) => {
            const container = document.getElementById('panorama');
            container.innerHTML = '';
            const config = {
                type: 'equirectangular',
                panorama: panoramaPath,
                autoLoad: true,
                showControls: true,
                compass: false,
                hfov: 100
            };
            if (view) {
                config.yaw = view.yaw;
                config.pitch = view.pitch;
                config.hfov = view.hfov;
            }
            state.viewer = pannellum.viewer('panorama', config);
        };

        const hasDatasetFile = (datasetKey, filename) => datasetSets[datasetKey].has(filename);

        const updateDatasetButtons = (filename) => {
            refs.datasetButtons.forEach((btn) => {
                const key = btn.dataset.dataset;
                const available = hasDatasetFile(key, filename);
                btn.disabled = !available;
                btn.classList.toggle('active', key === state.dataset);
            });
        };

        const updateThumbnails = () => {
            [...refs.thumbnailGrid.children].forEach((node, idx) => {
                node.classList.toggle('active', idx === state.index);
            });
        };

        const showStatus = (message = '') => {
            refs.statusMessage.textContent = message;
        };

        const getCurrentView = () => state.viewer ? {
            yaw: state.viewer.getYaw(),
            pitch: state.viewer.getPitch(),
            hfov: state.viewer.getHfov()
        } : null;

        const loadCurrentPanorama = ({ preserveView = false } = {}) => {
            const filename = panoramaList[state.index];
            const chosenDataset = hasDatasetFile(state.dataset, filename) ? state.dataset : 'panos';
            const view = preserveView ? getCurrentView() : null;

            if (chosenDataset !== state.dataset) {
                showStatus(`${datasetLabels[state.dataset]} 缺少 ${filename}，已回退到输入`);
            } else {
                showStatus('');
            }

            state.dataset = chosenDataset;
            const path = `${chosenDataset}/${filename}`;
            createViewer(path, view);

            refs.currentName.textContent = filename;
            refs.currentDataset.textContent = datasetLabels[chosenDataset];
            updateDatasetButtons(filename);
            updateThumbnails();
        };

        const placeholderSrc = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==';

        const loadThumbImage = (img) => {
            if (img.dataset.loaded === 'true') return;
            img.src = img.dataset.src;
            img.dataset.loaded = 'true';
        };

        const thumbObserver = 'IntersectionObserver' in window
            ? new IntersectionObserver((entries) => {
                entries.forEach((entry) => {
                    if (entry.isIntersecting) {
                        loadThumbImage(entry.target);
                        thumbObserver.unobserve(entry.target);
                    }
                });
            }, { root: document.getElementById('thumbnailGrid'), rootMargin: '100px' })
            : null;

        const goToIndex = (nextIndex, resetDataset = false) => {
            state.index = (nextIndex + panoramaList.length) % panoramaList.length;
            if (resetDataset) {
                state.dataset = 'panos';
            }
            loadCurrentPanorama();
        };

        const createThumbnails = () => {
            panoramaList.forEach((filename, index) => {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'thumbnail';

                const img = document.createElement('img');
                img.dataset.src = `panos/${filename}`;
                img.src = placeholderSrc;
                img.alt = filename;
                img.loading = 'lazy';
                if (thumbObserver) {
                    thumbObserver.observe(img);
                } else {
                    loadThumbImage(img);
                }

                const caption = document.createElement('span');
                caption.textContent = filename.replace('.png', '');

                button.appendChild(img);
                button.appendChild(caption);
                button.addEventListener('click', () => goToIndex(index, true));

                refs.thumbnailGrid.appendChild(button);
            });
        };

        document.getElementById('prevBtn').addEventListener('click', () => goToIndex(state.index - 1, true));

        document.getElementById('nextBtn').addEventListener('click', () => goToIndex(state.index + 1, true));

        refs.datasetButtons.forEach((btn) => {
            btn.addEventListener('click', () => {
                const key = btn.dataset.dataset;
                if (key === state.dataset) return;
                state.dataset = key;
                loadCurrentPanorama({ preserveView: true });
            });
        });

        document.addEventListener('keydown', (event) => {
            if (event.key === 'ArrowLeft') {
                goToIndex(state.index - 1, true);
            } else if (event.key === 'ArrowRight') {
                goToIndex(state.index + 1, true);
            }
        });

        createThumbnails();
        loadCurrentPanorama();
    </script>
</body>
</html>
